---
kind: pipeline
name: rancher-deploy

steps:
  - name: Fetch full git repo
    image: docker:git
    commands:
      - git fetch --all
  - name: Dump git environment
    image: docker:git
    commands:
      - env
      - ls -la .git
      - git remote -v
      - git rev-parse --abbrev-ref HEAD
      - git branch -a
      - git describe --all
  - name: Dump commands
    image: docker:git
    commands:
      - git branch -a --contains $DRONE_TAG
    when:
      event:
        - tag
  - name: Check tag is on master
    image: uala/drone-rancher-deploy
    settings:
      action: tag_check
      enforce_branch_for_tag: master
      fetch: true
    when:
      event:
        - tag
  - name: rancher-deploy
    image: uala/drone-rancher-deploy
    settings:
      config: k8s-envs.yml
      dry_run: true
    environment:
      RANCHER_ACCESS_KEY:
        from_secret: RANCHER_ACCESS_KEY
      RANCHER_SECRET_KEY:
        from_secret: RANCHER_SECRET_KEY
